{
  "task_id": "02-03",
  "phase": 2,
  "step": 3,
  "name": "Add import and final test structure",
  "description": "Finalize the test file with proper imports and structure. Add the import statement that will work once implementation exists.",
  "motivation": "Complete test file structure ready for Green phase. The try/except import allows pytest to collect tests even when the function doesn't exist yet.",
  "context": {
    "files_to_read": [
      "tests/unit/test_git_detection.py"
    ],
    "files_to_modify": [
      "tests/unit/test_git_detection.py"
    ],
    "files_to_create": [],
    "prerequisites": [
      "Step 02-02 completed (all test methods exist)"
    ],
    "reference_documents": []
  },
  "instructions": [
    "Finalize tests/unit/test_git_detection.py by combining all test methods from steps 02-01 and 02-02 into one complete file:",
    "",
    "```python",
    "\"\"\"Unit tests for git repository detection.",
    "",
    "Tests the is_inside_git_repo() function that detects whether",
    "the current working directory is inside a git repository.",
    "",
    "Reference: ADR-001-git-detection-algorithm.md",
    "Acceptance Criteria: AC-001 through AC-007",
    "\"\"\"",
    "import pytest",
    "import signal",
    "from pathlib import Path",
    "",
    "# Import the function under test",
    "# This will fail until implementation in Phase 3",
    "import sys",
    "sys.path.insert(0, str(Path(__file__).parent.parent.parent / 'hooks'))",
    "",
    "try:",
    "    from post_gen_project import is_inside_git_repo",
    "except ImportError:",
    "    # Function not yet implemented - define placeholder for test collection",
    "    def is_inside_git_repo():",
    "        raise NotImplementedError('Function not yet implemented')",
    "",
    "",
    "class TestIsInsideGitRepo:",
    "    \"\"\"Test suite for is_inside_git_repo() function.",
    "",
    "    Covers all 7 acceptance criteria:",
    "    - AC-001: Detection in current directory",
    "    - AC-002: Detection at any parent level",
    "    - AC-003: .git file detection (worktrees)",
    "    - AC-004: Parent directory traversal",
    "    - AC-005: Reserved for future use",
    "    - AC-006: Reserved for future use",
    "    - AC-007: Clean directory returns False",
    "    \"\"\"",
    "",
    "    # From Step 02-01: Positive detection cases (4 tests)",
    "    def test_detects_git_directory_in_current_directory(self, tmp_path, monkeypatch):",
    "        \"\"\"AC-001: Detection works for .git in current directory.\"\"\"",
    "        git_dir = tmp_path / '.git'",
    "        git_dir.mkdir()",
    "        monkeypatch.chdir(tmp_path)",
    "        result = is_inside_git_repo()",
    "        assert result is True",
    "",
    "    def test_detects_git_directory_in_parent_directory(self, tmp_path, monkeypatch):",
    "        \"\"\"AC-002: Detection works for .git at any parent level.\"\"\"",
    "        git_dir = tmp_path / '.git'",
    "        git_dir.mkdir()",
    "        nested_dir = tmp_path / 'level1' / 'level2'",
    "        nested_dir.mkdir(parents=True)",
    "        monkeypatch.chdir(nested_dir)",
    "        result = is_inside_git_repo()",
    "        assert result is True",
    "",
    "    def test_detects_git_directory_three_levels_up(self, tmp_path, monkeypatch):",
    "        \"\"\"AC-002: Detection works for .git 3+ levels up (monorepo scenario).\"\"\"",
    "        git_dir = tmp_path / '.git'",
    "        git_dir.mkdir()",
    "        nested_dir = tmp_path / 'services' / 'trading' / 'source'",
    "        nested_dir.mkdir(parents=True)",
    "        monkeypatch.chdir(nested_dir)",
    "        result = is_inside_git_repo()",
    "        assert result is True",
    "",
    "    def test_detects_git_file_for_worktree(self, tmp_path, monkeypatch):",
    "        \"\"\"AC-003: Detection works for .git file (worktrees, submodules).\"\"\"",
    "        git_file = tmp_path / '.git'",
    "        git_file.write_text('gitdir: /path/to/actual/git/dir')",
    "        monkeypatch.chdir(tmp_path)",
    "        result = is_inside_git_repo()",
    "        assert result is True",
    "",
    "    # From Step 02-02: Negative detection cases (3 tests)",
    "    def test_returns_false_when_no_git_in_tree(self, tmp_path, monkeypatch):",
    "        \"\"\"AC-007: Clean directory returns False for full git init.\"\"\"",
    "        clean_dir = tmp_path / 'clean_project'",
    "        clean_dir.mkdir()",
    "        monkeypatch.chdir(clean_dir)",
    "        result = is_inside_git_repo()",
    "        assert result is False",
    "",
    "    def test_stops_at_filesystem_root(self, tmp_path, monkeypatch):",
    "        \"\"\"Edge case: Traversal stops at filesystem root without infinite loop.\"\"\"",
    "        deep_dir = tmp_path / 'a' / 'b' / 'c' / 'd' / 'e'",
    "        deep_dir.mkdir(parents=True)",
    "        monkeypatch.chdir(deep_dir)",
    "        def timeout_handler(signum, frame):",
    "            raise TimeoutError('Function did not terminate')",
    "        signal.signal(signal.SIGALRM, timeout_handler)",
    "        signal.alarm(2)",
    "        try:",
    "            result = is_inside_git_repo()",
    "            signal.alarm(0)",
    "        except TimeoutError:",
    "            pytest.fail('is_inside_git_repo() did not terminate - possible infinite loop')",
    "        assert result is False",
    "",
    "    def test_does_not_detect_sibling_git_directory(self, tmp_path, monkeypatch):",
    "        \"\"\"Edge case: .git in sibling directory should not be detected.\"\"\"",
    "        sibling_with_git = tmp_path / 'sibling_repo'",
    "        sibling_with_git.mkdir()",
    "        (sibling_with_git / '.git').mkdir()",
    "        current_dir = tmp_path / 'my_project'",
    "        current_dir.mkdir()",
    "        monkeypatch.chdir(current_dir)",
    "        result = is_inside_git_repo()",
    "        assert result is False",
    "```",
    "",
    "Verify all 7 test methods exist by running test collection.",
    "The import fallback allows pytest to collect tests even before implementation exists."
  ],
  "acceptance_criteria": [
    "Test file exists at tests/unit/test_git_detection.py",
    "Complete imports: pytest, signal, pathlib, sys",
    "Fallback import with try/except for pre-implementation phase (NotImplementedError placeholder)",
    "TestIsInsideGitRepo class contains exactly 7 test methods:",
    "  - test_detects_git_directory_in_current_directory (AC-001)",
    "  - test_detects_git_directory_in_parent_directory (AC-002)",
    "  - test_detects_git_directory_three_levels_up (AC-002)",
    "  - test_detects_git_file_for_worktree (AC-003)",
    "  - test_returns_false_when_no_git_in_tree (AC-007)",
    "  - test_stops_at_filesystem_root (timeout protection)",
    "  - test_does_not_detect_sibling_git_directory (isolation)",
    "All 7 test methods discoverable by pytest with correct names",
    "Tests fail with NotImplementedError when run (Red phase - function not yet implemented)"
  ],
  "verification": {
    "command": "pipenv run pytest tests/unit/test_git_detection.py --collect-only -q",
    "expected": "Collects 7 tests: test_detects_git_directory_in_current_directory, test_detects_git_directory_in_parent_directory, test_detects_git_directory_three_levels_up, test_detects_git_file_for_worktree, test_returns_false_when_no_git_in_tree, test_stops_at_filesystem_root, test_does_not_detect_sibling_git_directory"
  },
  "estimated_minutes": 15,
  "dependencies": [
    "02-02"
  ],
  "state": {
    "status": "pending",
    "ready_for_execution": false,
    "ready_when": "Step 02-02 completed (all negative test cases added)"
  },
  "agent_notes": "Consolidation step: combines all 7 tests from 02-01 and 02-02 into final test file. The try/except import pattern allows pytest to collect tests even before implementation phase. Tests WILL fail (Red phase) because is_inside_git_repo() raises NotImplementedError. This is expected behavior. After verification passes, proceed to Phase 3 for implementation."
}
